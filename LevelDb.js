// Copyright (c) Microsoft Corporation. Licensed under the MIT License.
import*as k from"pako";var h=class{constructor(e,t){this.byteLength=0;this.value=0;this.fileBytes=e,this.startIndex=t;let i=0;for(;this.fileBytes[this.startIndex+i]>=128&&this.startIndex+i<e.length;)i++;for(this.byteLength=i+1,this.value=this.fileBytes[this.startIndex+i];i>0;)this.value*=128,this.value+=this.fileBytes[this.startIndex+i-1]-128,i--}};var S=class{get unsharedKey(){if(this.unsharedKeyBytes===void 0)return;let e=new DataView(this.unsharedKeyBytes.buffer,this.unsharedKeyBytes.byteOffset,this.unsharedKeyBytes.byteLength);return m.getAsciiString(e,0,e.byteLength)}get key(){if(this.keyCached)return this.keyCached;let e=this.previousKey,t="";e!==void 0&&(t=e.key.substring(0,this.sharedByteLength));let i=this.unsharedKey;return i!==void 0&&(t+=i),this.keyCached=t,t}get keyBytes(){if(!this.unsharedKeyBytes)return;if(this.fullBytesCached)return this.fullBytesCached;if(this.sharedByteLength===void 0||this.sharedByteLength===0)return this.unsharedKeyBytes;if(this.previousKey===void 0)throw new Error("Unexpected shared key without a previous");let e=this.previousKey.keyBytes;if(e===void 0)throw new Error("Unexpected shared key without previous bytes");let t=new Uint8Array(this.sharedByteLength+this.unsharedKeyBytes.length),i=this.sharedByteLength;for(let r=0;r<i;r++)t[r]=e[r];for(let r=0;r<this.unsharedKeyBytes.length;r++)t[r+i]=this.unsharedKeyBytes[r];return this.fullBytesCached=t,t}get isRestart(){return this.sharedByteLength===0}loadFromLdb(e,t,i){this.fileBytes=e,this.startIndex=t;let r=0,n=new h(this.fileBytes,this.startIndex);this.sharedByteLength=n.value,r+=n.byteLength,this.sharedByteLength>0&&(this.previousKey=i);let s=new h(this.fileBytes,this.startIndex+r);r+=s.byteLength;let l=new h(this.fileBytes,this.startIndex+r);r+=l.byteLength,this.unsharedKeyBytes=e.subarray(t+r,t+r+s.value-8),r+=s.value,this.value=e.subarray(t+r,t+r+l.value),r+=l.value,this.length=r}},m=class B{static getAsciiString(e,t,i,r){return B.readStringASCII(e,t,i).str}static getAsciiStringFromUint8Array(e){let t="";for(let i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);return t}static readStringASCII(e,t,i){var r="",n=0;t=t||0;var s=!1;typeof i>"u"&&(s=!0,i=e.byteLength-e.byteOffset);for(var l,u=0;u<i&&(l=e.getUint8(u+t),!(l===0&&s));u++)r+=String.fromCharCode(l),n++;return{str:r,byteLength:n+(s?1:0)}}},U=class{static getUnsignedInteger(e,t,i,r,n){let s=new ArrayBuffer(4),l=new Uint8Array(s);return l[0]=e,l[1]=t,l[2]=i,l[3]=r,new DataView(s).getUint32(0,n)}static getUnsignedShort(e,t,i){let r=new ArrayBuffer(2),n=new Uint8Array(r);return n[0]=e,n[1]=t,new DataView(r).getUint16(0,i)}},I=class{constructor(e,t,i,r){this.ldbFiles=e,this.logFiles=t,this.manifestFiles=i,this.context=r,this.keys={}}async init(e){this.keys={};for(let n=0;n<this.manifestFiles.length;n++){await this.manifestFiles[n].loadContent(!1);let s=this.manifestFiles[n].content;s instanceof Uint8Array&&s.length>0&&(this.parseManifestContent(s,this.manifestFiles[n].storageRelativePath),e&&await e("Loaded map manifest file '"+this.manifestFiles[n].fullPath+"'."))}let t=[];for(let n=0;n<this.ldbFiles.length;n++){let s=this.ldbFiles[n];try{let l=parseInt(s.name);if(!this.deletedFileNumber||!this.deletedFileNumber.includes(l)){let u=0;if(this.newFileLevel&&this.newFileNumber&&(console.assert(this.newFileLevel.length===this.newFileNumber.length),this.newFileLevel.length===this.newFileNumber.length))for(let o=0;o<this.newFileNumber.length;o++)this.newFileNumber[o]===l&&(u=this.newFileLevel[o]);t.push({index:l,file:s,isDeleted:!1,level:u})}}catch(l){console.error("Error including LDB file: "+s.fullPath+" Error: "+l.toString())}}let i=t.sort((n,s)=>n.level===s.level?n.index-s.index:s.level-n.level);for(let n=0;n<i.length;n++){let s=i[n].file;await s.loadContent(!1);let l=s.content;if(l instanceof Uint8Array&&l.length>0){let u=this.parseLdbContent(l,s.storageRelativePath);e&&await e("Loaded map record file '"+s.fullPath+"'. Records: "+u)}}let r=this.logFiles.sort((n,s)=>n.name.localeCompare(s.name));for(let n=0;n<r.length;n++){await r[n].loadContent(!1);let s=r[n].content;if(s instanceof Uint8Array&&s.length>0){let l=this.parseLogContent(s,r[n].storageRelativePath);e&&await e("Loaded map latest-updates file '"+r[n].fullPath+"'. Records: "+l)}}}parseLdbContent(e,t){let i=0;if(e.length<=8||e[e.length-8]!==87||e[e.length-7]!==251||e[e.length-6]!==128||e[e.length-5]!==139||e[e.length-4]!==36||e[e.length-3]!==117||e[e.length-2]!==71||e[e.length-1]!==219){console.error("Unexpected bytes in LDB file. File seems unreadable.",t);return}let r=e.length-48,n=new h(e,r);r+=n.byteLength;let s=new h(e,r);r+=s.byteLength;let l=new h(e,r);r+=l.byteLength;let u=new h(e,r);if(r+=u.byteLength,l.value<=0||l.value+u.value>=e.length)return console.error("LDB content index offset not within bounds.",t),!1;if(n.value<=0||n.value+s.value>=e.length)return console.error("LDB meta index offset not within bounds.",t),!1;let o=e.subarray(l.value,l.value+u.value),a;try{a=k.inflate(o,{raw:!0})}catch{}if(!a)try{a=k.inflate(o)}catch{}if(a||(a=o,console.error("Treating level DB content as compressed.",t)),a){let d={};if(!this.parseIndexBytes(a,0,a.length,d,t))return!1;for(let w in d){let y=d[w];if(y&&y.value){let p=y.value,c=0,b=new h(p,c);c+=b.byteLength;let v=new h(p,c);if(c+=v.byteLength,b.value<0||b.value+v.value>=e.length){console.error("Block offset does not appear correct",t);return}if(c!==p.length){console.error("Index byte index is not correct",t);return}let L=e.subarray(b.value,b.value+v.value),g;try{g=k.inflate(L,{raw:!0})}catch{}if(!g)try{g=k.inflate(L)}catch{}g||(g=L),i+=this.parseLdbBlockBytes(g,0,g.length,t)}else console.error("Could not find index key.",t)}}return i===0&&console.error("No keys found in LDB.",t),i}parseIndexBytes(e,t,i,r,n){let s=t,l,o=U.getUnsignedInteger(e[i-4],e[i-3],e[i-2],e[i-1],!0)*4+4;for(;s<t+i-o;){let a=new S;a.loadFromLdb(e,s,l);let d=a.key;if(l=a,r[d]=a,a.length===void 0)return console.error("Unexpected parse of level key value "+d,n),!1;s+=a.length}return!0}parseLdbBlockBytes(e,t,i,r){let n=t,s=0,l,o=U.getUnsignedInteger(e[i-4],e[i-3],e[i-2],e[i-1],!0)*4+4;if(o>t+i)return console.error("Unexpected size received for LDB bytes. File could be corrupt.",r),0;for(;n<t+i-o;){let a=new S;a.loadFromLdb(e,n,l);let d=a.key;if(l=a,this.keys[d]=a,a.length===void 0||a.length<0)throw new Error(`Unexpected parse of key ${d}
${r}`);s++,n+=a.length}return s}parseLogContent(e,t){let i=0,r,n=0;for(;i<e.length-6;){let s=U.getUnsignedShort(e[i+4],e[i+5],!0),l=e[i+6];if(i+=7,l===1)n+=this.addValueFromLog(e,i,s,t);else if(l===2)r=new Uint8Array(e.buffer,i,s);else if(l===3||l===4)if(r!==void 0){let o=new Uint8Array(e.buffer,i,s),a=new Uint8Array(r.byteLength+o.byteLength);a.set(r),a.set(o,r.byteLength),r=a,l===4&&(n+=this.addValueFromLog(r,0,r.length,t))}else{console.error("Unexpected middle to a set of bytes found within LevelDB content. File seems unreadable.",t);return}else{console.error("Unexpected type for log file. File seems unreadable.",t);return}i+=s;let u=32768-i%32768;for(;u<=6&&u>0;)u--,e[i]!==0&&console.error("Unexpectedly found a padding trailer with data",t),i++}return n<=0&&console.error("Did not find any keys in log file",t),n}addValueFromLog(e,t,i,r){let n=t;t+=12;let s=0;for(;t<=n+i-5;){let l=e[t];t++;let u=new h(e,t);t+=u.byteLength;let o=new Uint8Array(u.value);for(let a=0;a<u.value;a++)o[a]=e[t+a];if(t+=u.value,t>e.length&&console.error("Unexpected log file length issue.",r),t<=e.length){let a=m.getAsciiStringFromUint8Array(o);if(a===void 0&&console.error("Unexpected empty key in a log file. File could be unreadable.",r),s++,l){t>=e.length&&console.error("Unexpectedly leftover content in a log file. File could be unreadable.",r);let d=new h(e,t);if(t+=d.byteLength,d.value+t<=e.buffer.byteLength){let w=new Uint8Array(e.buffer,t,d.value);t+=d.value;let y=new S;y.sharedKey="",y.keyDelta=a,y.unsharedKeyBytes=o,y.value=w,this.keys[a]=y}}else this.keys[a]=!1}}return s}parseManifestContent(e,t){let i=0,r;for(this.comparator=void 0,this.logNumber=void 0,this.nextFileNumber=void 0,this.lastSequence=void 0,this.compactPointerLevels=void 0,this.compactPointerStrings=void 0,this.deletedFileLevel=void 0,this.deletedFileNumber=void 0,this.newFileLevel=void 0,this.newFileNumber=void 0,this.newFileSize=void 0,this.newFileSmallest=void 0,this.newFileLargest=void 0;i<e.length-6;){let n=U.getUnsignedShort(e[i+4],e[i+5],!0),s=e[i+6];if(i+=7,s===1)this.addValueFromManifest(e,i,n);else if(s===2)r=new Uint8Array(e.buffer,i,n);else if(s===3||s===4)if(r!==void 0){let u=new Uint8Array(e.buffer,i,n),o=new Uint8Array(r.byteLength+u.byteLength);o.set(r),o.set(u,r.byteLength),r=o,s===4&&this.addValueFromManifest(r,0,r.length)}else{console.error("Unexpected middle to a set of bytes found within a manifest file. File could be unreadable.",t);return}else{console.error("Unexpected type for manifest file.  File could be unreadable.",t);return}i+=n;let l=32768-i%32768;for(;l<=6&&l>0;)l--,e[i]!==0&&console.error("Unexpectedly found a padding trailer with data in a manifest file.",t),i++}}addValueFromManifest(e,t,i,r){let n=t;for(;t<n+i;){let s=new h(e,t);switch(t+=s.byteLength,s.value){case 1:let l=new h(e,t);t+=l.byteLength;let u=new Uint8Array(l.value);for(let f=0;f<l.value;f++)u[f]=e[t+f];t+=l.value,t>e.length&&console.error("Unexpected manifest file length issue.",r),this.comparator=m.getAsciiStringFromUint8Array(u),this.comparator===void 0&&console.error("Unexpected comparator.",r);break;case 2:let o=new h(e,t);t+=o.byteLength,this.logNumber=o.value;break;case 3:let a=new h(e,t);t+=a.byteLength,this.nextFileNumber=a.value;break;case 4:let d=new h(e,t);t+=d.byteLength,this.lastSequence=d.value;break;case 5:this.compactPointerLevels===void 0&&(this.compactPointerLevels=[]),this.compactPointerStrings===void 0&&(this.compactPointerStrings=[]);let w=new h(e,t);t+=w.byteLength,this.compactPointerLevels.push(w.value);let y=new h(e,t);t+=y.byteLength;let p=new Uint8Array(y.value);for(let f=0;f<y.value;f++)p[f]=e[t+f];t+=y.value,t>e.length&&console.error("Unexpected manifest file length issue at compact pointer.",r),this.compactPointerStrings.push(m.getAsciiStringFromUint8Array(p)),this.compactPointerStrings[this.compactPointerStrings.length-1]===void 0&&console.error("Unexpected compact pointer string.",r);break;case 6:this.deletedFileLevel===void 0&&(this.deletedFileLevel=[]),this.deletedFileNumber===void 0&&(this.deletedFileNumber=[]);let c=new h(e,t);t+=c.byteLength,this.deletedFileLevel.push(c.value);let b=new h(e,t);t+=b.byteLength,this.deletedFileNumber.push(b.value);break;case 7:this.newFileLargest===void 0&&(this.newFileLargest=[]),this.newFileLevel===void 0&&(this.newFileLevel=[]),this.newFileNumber===void 0&&(this.newFileNumber=[]),this.newFileSmallest===void 0&&(this.newFileSmallest=[]),this.newFileSize===void 0&&(this.newFileSize=[]);let v=new h(e,t);t+=v.byteLength,this.newFileLevel.push(v.value);let L=new h(e,t);t+=L.byteLength,this.newFileNumber.push(L.value);let g=new h(e,t);t+=g.byteLength,this.newFileSize.push(g.value);let F=new h(e,t);t+=F.byteLength;let C=new Uint8Array(F.value);for(let f=0;f<F.value;f++)C[f]=e[t+f];t+=F.value,t>e.length&&console.error("Unexpected manifest file length issue at new file smallest.",r),this.newFileSmallest.push(m.getAsciiStringFromUint8Array(C)),this.newFileSmallest[this.newFileSmallest.length-1]===void 0&&console.error("Unexpected file smallest tag string.",r);let A=new h(e,t);t+=A.byteLength;let N=new Uint8Array(A.value);for(let f=0;f<A.value;f++)N[f]=e[t+f];t+=A.value,t>e.length&&console.error("Unexpected manifest file length issue at new file largest.",r),this.newFileLargest.push(m.getAsciiStringFromUint8Array(N)),this.newFileLargest[this.newFileLargest.length-1]===void 0&&console.error("Unexpected file largest tag string.",r);break;case 9:let K=new h(e,t);t+=K.byteLength,this.previousLogNumber=K.value;break;default:console.error("Unexpected manifest item: "+s.value,r)}}}};export{I as default};
